<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional Order Management & Analytics</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        :root {
            --bg-color: #eef1f5; /* Lighter, more professional background */
            --text-color: #34495e; /* Softer black */
            --container-bg: #ffffff;
            --primary-color: #3498db; /* A nice blue */
            --primary-hover: #2980b9;
            --secondary-color: #2ecc71; /* Green for positive/profit */
            --secondary-hover: #27ae60;
            --danger-color: #e74c3c;
            --danger-hover: #c0392b;
            --warning-color: #f39c12; /* Orange for pending/warnings */
            --table-header-bg: #34495e; /* Darker header */
            --table-header-text: #ecf0f1;
            --table-border-color: #dce4ec;
            --input-border-color: #bdc3c7;
            --input-focus-border: var(--primary-color);
            --modal-bg: rgba(0, 0, 0, 0.5);
            --modal-content-bg: #ffffff;
            --box-shadow-light: rgba(0, 0, 0, 0.05);
            --box-shadow-strong: rgba(0, 0, 0, 0.1);
            --even-row-bg: #f8f9fa;
            --disabled-bg: #e9ecef;
            --disabled-text: #6c757d;
        }

        body.dark-theme {
            --bg-color: #1c2025;
            --text-color: #e0e6ed;
            --container-bg: #282c34;
            --primary-color: #3498db; /* Keep blue vibrant */
            --primary-hover: #2c7fb8;
            --secondary-color: #2ecc71;
            --secondary-hover: #25a25a;
            --danger-color: #e74c3c;
            --danger-hover: #c0392b;
            --warning-color: #f39c12;
            --table-header-bg: #3a4149;
            --table-header-text: #e0e6ed;
            --table-border-color: #4a5158;
            --input-border-color: #5a6168;
            --input-focus-border: var(--primary-color);
            --modal-bg: rgba(0, 0, 0, 0.7);
            --modal-content-bg: #31363f;
            --box-shadow-light: rgba(255, 255, 255, 0.03);
            --box-shadow-strong: rgba(255, 255, 255, 0.07);
            --even-row-bg: #2c3038;
            --disabled-bg: #40454c;
            --disabled-text: #90979e;
        }

        body {
            font-family: 'Roboto', 'Segoe UI', Arial, sans-serif;
            margin: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
            font-size: 15px;
            line-height: 1.6;
        }

        .container {
            max-width: 1600px; /* Wider for more columns */
            margin: 20px auto;
            background-color: var(--container-bg);
            padding: 20px 30px;
            border-radius: 8px;
            box-shadow: 0 4px 12px var(--box-shadow-strong);
            transition: background-color 0.3s;
        }

        h1 {
            color: var(--primary-color);
            text-align: center;
            margin-bottom: 15px;
            font-size: 2em;
            font-weight: 500;
        }
        h1 .fa-chart-line { margin-right: 10px; }

        .main-controls {
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background-color: var(--container-bg); /* For contrast if body is different */
            border-radius: 6px;
            box-shadow: 0 2px 6px var(--box-shadow-light);
            flex-wrap: wrap;
            gap: 15px;
        }
        .main-controls .actions, .main-controls .tools {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .search-bar {
            display: flex;
            align-items: center;
            background-color: var(--bg-color); /* Input background */
            border: 1px solid var(--input-border-color);
            border-radius: 5px;
            padding: 0 10px;
        }
        .search-bar input[type="search"] {
            border: none;
            padding: 10px;
            font-size: 1em;
            background-color: transparent;
            color: var(--text-color);
            outline: none;
            width: 250px;
        }
        .search-bar .fa-search { color: var(--text-color); opacity: 0.7;}


        /* Summary Dashboard */
        .summary-dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        .summary-card {
            background-color: var(--container-bg);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px var(--box-shadow-light);
            text-align: center;
        }
        .summary-card .fa-stack { font-size: 1.5em; margin-bottom: 10px; }
        .summary-card h3 {
            margin-top: 0;
            margin-bottom: 5px;
            font-size: 0.9em;
            color: var(--text-color);
            opacity: 0.8;
            text-transform: uppercase;
        }
        .summary-card p {
            margin-bottom: 0;
            font-size: 1.8em;
            font-weight: 600;
            color: var(--primary-color);
        }
        .summary-card.profit p.profit-positive { color: var(--secondary-color); }
        .summary-card.profit p.profit-negative { color: var(--danger-color); }
        .summary-card.cost p { color: var(--danger-color); }


        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 15px;
            text-align: center;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 0.95em;
            font-weight: 500;
            cursor: pointer;
            border-radius: 5px;
            transition: background-color 0.2s ease-in-out, box-shadow 0.2s;
        }
        button:hover {
            background-color: var(--primary-hover);
            box-shadow: 0 2px 5px rgba(0,0,0,0.15);
        }
        button:active { transform: translateY(1px); }

        button.danger { background-color: var(--danger-color); }
        button.danger:hover { background-color: var(--danger-hover); }
        button.secondary { background-color: #7f8c8d; } /* Greyish */
        button.secondary:hover { background-color: #6c7a7b; }
        button.info { background-color: #5bc0de; } /* Light Blue for info */
        button.info:hover { background-color: #31b0d5; }
        button.action-btn { /* Smaller buttons for table actions */
            padding: 6px 10px;
            font-size: 0.85em;
            gap: 5px;
        }


        .table-responsive { overflow-x: auto; }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 0.9em;
        }
        th, td {
            border: 1px solid var(--table-border-color);
            padding: 10px 8px; /* Slightly less padding */
            text-align: left;
            vertical-align: middle;
        }
        th {
            background-color: var(--table-header-bg);
            color: var(--table-header-text);
            font-weight: 600;
            white-space: nowrap;
        }
        tr:nth-child(even) { background-color: var(--even-row-bg); }
        tr:hover {
            background-color: var(--primary-hover) !important;
            color: white;
        }
        tr:hover td, tr:hover .fa { color: white !important; }
        td.actions-cell { white-space: nowrap; text-align: center;}
        .profit-positive { color: var(--secondary-color); font-weight: bold; }
        .profit-negative { color: var(--danger-color); font-weight: bold; }

        .empty-message {
            text-align: center;
            font-style: italic;
            color: #777;
            padding: 30px;
            font-size: 1.1em;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1050; /* Higher than other elements */
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow-y: auto; /* Scroll modal content if too tall */
            background-color: var(--modal-bg);
        }
        .modal-dialog {
            position: relative;
            margin: 1.75rem auto;
            pointer-events: none;
            max-width: 800px; /* Wider modal for more fields */
        }
         .modal-dialog.modal-dialog-scrollable .modal-content {
            max-height: calc(100vh - 3.5rem); /* Adjust based on margin */
            overflow: hidden;
        }
        .modal-dialog.modal-dialog-scrollable .modal-body {
            overflow-y: auto;
        }
        .modal-content {
            position: relative;
            display: flex;
            flex-direction: column;
            width: 100%;
            pointer-events: auto;
            background-color: var(--modal-content-bg);
            background-clip: padding-box;
            border: 1px solid rgba(0,0,0,.2);
            border-radius: .5rem;
            outline: 0;
            color: var(--text-color);
        }
        .modal-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--table-border-color);
            border-top-left-radius: calc(.5rem - 1px);
            border-top-right-radius: calc(.5rem - 1px);
        }
        .modal-header h2 {
            margin-bottom: 0;
            line-height: 1.5;
            font-size: 1.5em;
            color: var(--primary-color);
        }
        .close-button {
            padding: 1rem 1rem;
            margin: -1rem -1rem -1rem auto;
            background-color: transparent;
            border: 0;
            font-size: 1.5rem;
            font-weight: 700;
            line-height: 1;
            color: var(--text-color);
            text-shadow: 0 1px 0 #fff;
            opacity: .5;
            cursor: pointer;
        }
        body.dark-theme .close-button { text-shadow: none; }
        .close-button:hover { opacity: .75; }

        .modal-body { position: relative; flex: 1 1 auto; padding: 1.5rem; }
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 15px 20px;
        }
        .form-group { margin-bottom: 0; } /* Gap handles spacing */
        .form-group label {
            display: block;
            margin-bottom: .3rem;
            font-weight: 500;
            font-size: 0.9em;
        }
        .form-group label .fa { margin-right: 5px; opacity: 0.7; }
        .form-group input, .form-group select, .form-group textarea {
            display: block;
            width: 100%;
            padding: .5rem .75rem;
            font-size: 1rem;
            font-weight: 400;
            line-height: 1.5;
            color: var(--text-color);
            background-color: var(--bg-color);
            background-clip: padding-box;
            border: 1px solid var(--input-border-color);
            appearance: none;
            border-radius: .25rem;
            transition: border-color .15s ease-in-out,box-shadow .15s ease-in-out;
            box-sizing: border-box;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            border-color: var(--input-focus-border);
            outline: 0;
            box-shadow: 0 0 0 .2rem rgba(52,152,219,.25); /* primary-color with alpha */
        }
        .form-group input[readonly] {
            background-color: var(--disabled-bg);
            color: var(--disabled-text);
            opacity: 1;
            cursor: not-allowed;
        }
        .form-group textarea { min-height: 70px; resize: vertical; }

        .modal-footer {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: flex-end;
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--table-border-color);
            border-bottom-right-radius: calc(.5rem - 1px);
            border-bottom-left-radius: calc(.5rem - 1px);
        }
        .modal-footer button:not(:last-child) { margin-right: .5rem; }

        /* Theme Toggle Switch - Reusing previous style */
        .theme-switch-wrapper { display: flex; align-items: center; }
        .theme-switch { display: inline-block; height: 24px; position: relative; width: 48px; }
        .theme-switch input { display:none; }
        .slider { background-color: #ccc; bottom: 0; cursor: pointer; left: 0; position: absolute; right: 0; top: 0; transition: .4s; border-radius: 24px; }
        .slider:before { background-color: #fff; bottom: 3px; content: ""; height: 18px; left: 3px; position: absolute; transition: .4s; width: 18px; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary-color); }
        input:checked + .slider:before { transform: translateX(24px); }
        .theme-switch-wrapper span { margin-left: 8px; font-size: 0.9em; }

        /* Details Modal Specific Styles */
        .details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 10px 20px;
            margin-bottom: 15px;
        }
        .detail-item {
            padding: 8px 0;
            border-bottom: 1px solid var(--table-border-color);
        }
        .detail-item:last-child { border-bottom: none; }
        .detail-label {
            font-weight: 600;
            color: var(--primary-color);
            display: block;
            margin-bottom: 3px;
            font-size: 0.9em;
        }
        .detail-label .fa { margin-right: 6px; opacity: 0.8; }
        .detail-value {
            word-break: break-word;
            font-size: 0.95em;
        }
        .detail-item-fullwidth {
            grid-column: 1 / -1; /* Span full width */
            padding: 8px 0;
            border-bottom: 1px solid var(--table-border-color);
        }
        .detail-item-fullwidth .detail-label { margin-bottom: 5px; }
        .detail-value-multiline {
            white-space: pre-wrap;
            word-break: break-word;
            background-color: var(--bg-color);
            padding: 8px 12px;
            border-radius: 4px;
            margin-top: 5px;
            border: 1px solid var(--input-border-color);
            font-size: 0.95em;
            line-height: 1.5;
        }
        body.dark-theme .detail-value-multiline {
            background-color: var(--even-row-bg); /* Slightly different from main bg */
        }


        /* Print specific */
        @media print {
            body { margin: 0; background-color: #fff !important; color: #000 !important; font-size: 9pt; }
            .container { box-shadow: none; border-radius: 0; padding: 0; max-width: 100%; }
            .main-controls, .modal:not(.print-this-modal), .summary-dashboard,
            .modal-header .close-button, .modal-footer button.secondary:not(#printOrderDetailBtn), /* Allow print button in details modal footer */
            .theme-switch-wrapper,
            th:last-child, td:last-child /* Hide Actions column in main table */
             { display: none !important; }

            table, th, td { border: 1px solid #666 !important; font-size: 8pt; padding: 5px; }
            th { background-color: #e0e0e0 !important; color: #000 !important; font-weight: bold; }
            tr:nth-child(even) { background-color: #fff !important; }
            h1 { text-align: left; font-size: 14pt; color: #000 !important; margin-bottom: 10px; }
            .modal-content { border: none; box-shadow: none; }
            .profit-positive { color: green !important; }
            .profit-negative { color: red !important; }
            .table-responsive { overflow: visible; }

            /* Print specific for Order Details Modal */
            body.print-details-modal-active { visibility: hidden; }
            body.print-details-modal-active .modal.print-this-modal,
            body.print-details-modal-active .modal.print-this-modal * {
                visibility: visible;
            }
            body.print-details-modal-active .modal.print-this-modal {
                position: absolute; left: 0; top: 0; width: 100%; max-width: 100%;
                height: auto; margin: 0; padding: 0; box-shadow: none; border: none;
                overflow: visible !important; background-color: #fff !important;
            }
            body.print-details-modal-active .modal.print-this-modal .modal-dialog {
                margin: 0; max-width: 100%;
            }
            body.print-details-modal-active .modal.print-this-modal .modal-content {
                border: none; box-shadow: none; border-radius: 0;
                color: #000 !important; background-color: #fff !important;
            }
            body.print-details-modal-active .modal.print-this-modal .modal-header .close-button,
            body.print-details-modal-active .modal.print-this-modal .modal-footer #closeDetailsModalFooterBtn {
                display: none !important; /* Hide close buttons in details modal for print */
            }
            body.print-details-modal-active .modal.print-this-modal .modal-header h2 {
                 color: #000 !important; font-size: 12pt;
            }
             body.print-details-modal-active .modal.print-this-modal .modal-body {
                padding: 10px;
            }
            body.print-details-modal-active .details-grid {
                grid-template-columns: 1fr 1fr; font-size: 9pt; gap: 5px 15px;
            }
            body.print-details-modal-active .detail-item,
            body.print-details-modal-active .detail-item-fullwidth {
                padding: 4px 0; font-size: 9pt;
                border-bottom: 1px solid #ccc !important;
            }
            body.print-details-modal-active .detail-label { color: #333 !important; font-size: 8.5pt;}
            body.print-details-modal-active .detail-value { font-size: 8.5pt;}
            body.print-details-modal-active .detail-value-multiline {
                background-color: #f9f9f9 !important; border: 1px solid #ddd !important;
                padding: 5px; font-size: 8.5pt;
            }
        }
    </style>
</head>
<body>

    <div class="container">
        <h1><i class="fas fa-chart-line"></i> Order Management & Analytics</h1>

        <div class="main-controls">
            <div class="actions">
                <button id="addOrderModalBtn"><i class="fas fa-plus-circle"></i> Add Order</button>
                <button id="printOrdersBtn"><i class="fas fa-print"></i> Print View</button>
                <button id="clearOrdersBtn" class="danger"><i class="fas fa-trash-alt"></i> Clear All</button>
                
                 <a href="/"><button><i class="fab fa-google"></i> Home</button></a>
            </div>
            <div class="tools">
                <div class="search-bar">
                     <i class="fas fa-search"></i>
                    <input type="search" id="searchInput" placeholder="Search orders...">
                </div>
                <div class="theme-switch-wrapper">
                    <label class="theme-switch" for="themeCheckbox">
                        <input type="checkbox" id="themeCheckbox" />
                        <div class="slider round"></div>
                    </label>
                    <span id="themeLabel">Dark Mode</span>
                </div>
            </div>
        </div>

        <div class="summary-dashboard">
            <div class="summary-card">
                <span class="fa-stack fa-2x"><i class="fas fa-circle fa-stack-2x" style="color: #3498db30;"></i><i class="fas fa-shopping-cart fa-stack-1x" style="color: var(--primary-color);"></i></span>
                <h3>Total Orders</h3>
                <p id="summaryTotalOrders">0</p>
            </div>
            <div class="summary-card">
                <span class="fa-stack fa-2x"><i class="fas fa-circle fa-stack-2x" style="color: #f39c1230;"></i><i class="fas fa-dollar-sign fa-stack-1x" style="color: var(--warning-color);"></i></span>
                <h3>Total Revenue</h3>
                <p id="summaryTotalRevenue">$0.00</p>
            </div>
             <div class="summary-card cost">
                <span class="fa-stack fa-2x"><i class="fas fa-circle fa-stack-2x" style="color: #e74c3c30;"></i><i class="fas fa-receipt fa-stack-1x" style="color: var(--danger-color);"></i></span>
                <h3>Total Cost</h3>
                <p id="summaryTotalCost">$0.00</p>
            </div>
            <div class="summary-card profit">
                <span class="fa-stack fa-2x"><i class="fas fa-circle fa-stack-2x" style="color: #2ecc7130;"></i><i class="fas fa-piggy-bank fa-stack-1x" style="color: var(--secondary-color);"></i></span>
                <h3>Total Profit</h3>
                <p id="summaryTotalProfit">$0.00</p>
            </div>
        </div>


        <div class="table-responsive">
            <table id="ordersTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Order Date</th>
                        <th>Customer</th>
                        <th>Item(s)</th>
                        <th>Platform</th> <!-- New Column -->
                        <th>Unit Price</th>
                        <th>Cost Price</th>
                        <th>Total Price</th>
                        <th>Profit</th>
                        <th>Pay Method</th>
                        <th>Pay Status</th>
                        <th>Order Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="ordersTableBody"></tbody>
            </table>
        </div>
        <p id="noOrdersMessage" class="empty-message" style="display:none;">No orders found. Add some to get started or refine your search.</p>
    </div>

    <!-- Add/Edit Order Modal -->
    <div id="orderModal" class="modal" tabindex="-1">
        <div class="modal-dialog modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="modalTitle" class="modal-title">Add New Order</h2>
                    <button type="button" class="close-button" id="closeModalBtn" aria-label="Close">×</button>
                </div>
                <form id="orderForm">
                    <div class="modal-body">
                        <input type="hidden" id="editOrderOriginalId" />
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="orderIdInput"><i class="fas fa-hashtag"></i> Order ID</label>
                                <input type="text" id="orderIdInput" required readonly>
                            </div>
                            <div class="form-group">
                                <label for="orderDate"><i class="fas fa-calendar-alt"></i> Order Date</label>
                                <input type="date" id="orderDate" required>
                            </div>
                            <div class="form-group">
                                <label for="customerName"><i class="fas fa-user"></i> Customer Name</label>
                                <input type="text" id="customerName" required>
                            </div>
                            <div class="form-group">
                                <label for="customerEmail"><i class="fas fa-envelope"></i> Customer Email</label>
                                <input type="email" id="customerEmail">
                            </div>
                             <div class="form-group">
                                <label for="itemName"><i class="fas fa-box-open"></i> Item Name(s)</label>
                                <input type="text" id="itemName" required>
                            </div>
                            <div class="form-group">
                                <label for="productSku"><i class="fas fa-barcode"></i> Product SKU</label>
                                <input type="text" id="productSku">
                            </div>
                             <div class="form-group">
                                <label for="platformInput"><i class="fas fa-store"></i> Platform</label>
                                <select id="platformInput">
                                    <option value="">Select Platform</option>
                                    <option value="Your TopUp Center">Your TopUp Center</option>
                                    <option value="Quantum SMM">Quantum SMM</option>
                                    <option value="WebUX">WebUX</option>
                                    <option value="Etsy">Etsy</option>
                                    <option value="Social Media">Social Media</option>
                                    <option value="Wholesale">Wholesale</option>
                                    <option value="In-Person">In-Person</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="quantity"><i class="fas fa-sort-numeric-up"></i> Quantity</label>
                                <input type="number" id="quantity" min="1" value="1" required>
                            </div>
                            <div class="form-group">
                                <label for="unitPrice"><i class="fas fa-tag"></i> Unit Price</label>
                                <input type="number" id="unitPrice" min="0" step="0.01" value="0.00" required>
                            </div>
                            <div class="form-group">
                                <label for="costPrice"><i class="fas fa-money-bill-wave"></i> Cost Price (per unit)</label>
                                <input type="number" id="costPrice" min="0" step="0.01" value="0.00" required>
                            </div>
                            <div class="form-group">
                                <label for="totalPrice"><i class="fas fa-cash-register"></i> Total Price</label>
                                <input type="text" id="totalPrice" readonly>
                            </div>
                             <div class="form-group">
                                <label for="paymentMethod"><i class="far fa-credit-card"></i> Payment Method</label>
                                <select id="paymentMethod">
                                    <option value="">Select</option>
                                    <option value="bKash">bKash</option>
                                    
                                    <option value="Nagad">Nagad</option>
                                    <option value="Rocket">Rocket</option>
                                    <option value="Cash">Cash</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="transactionId"><i class="fas fa-receipt"></i> Transaction ID</label>
                                <input type="text" id="transactionId">
                            </div>
                             <div class="form-group">
                                <label for="paymentDate"><i class="fas fa-calendar-check"></i> Payment Date</label>
                                <input type="date" id="paymentDate">
                            </div>
                            <div class="form-group">
                                <label for="paymentStatus"><i class="fas fa-credit-card"></i> Payment Status</label>
                                <select id="paymentStatus">
                                    <option value="Unpaid">Unpaid</option>
                                    <option value="Partially Paid">Partially Paid</option>
                                    <option value="Paid">Paid</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="orderStatus"><i class="fas fa-truck-loading"></i> Order Status</label>
                                <select id="orderStatus">
                                    <option value="Pending">Pending</option>
                                    <option value="Processing">Processing</option>
                                    <option value="Ready to Ship">Ready to Ship</option>
                                    <option value="Shipped">Shipped</option>
                                    <option value="Delivered">Delivered</option>
                                    <option value="Cancelled">Cancelled</option>
                                    <option value="Returned">Returned</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group" style="grid-column: 1 / -1; margin-top: 15px;">
                            <label for="shippingAddress"><i class="fas fa-map-marker-alt"></i> Shipping Address</label>
                            <textarea id="shippingAddress" rows="2"></textarea>
                        </div>
                        <div class="form-group" style="grid-column: 1 / -1; margin-top: 15px;">
                            <label for="notes"><i class="fas fa-sticky-note"></i> Notes/Comments</label>
                            <textarea id="notes" rows="2"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" id="cancelOrderBtn" class="secondary"><i class="fas fa-times-circle"></i> Cancel</button>
                        <button type="submit" id="saveOrderBtn"><i class="fas fa-save"></i> Save Order</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Order Details Modal -->
    <div id="orderDetailsModal" class="modal" tabindex="-1">
        <div class="modal-dialog modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="orderDetailsModalTitle" class="modal-title">Order Details</h2>
                    <button type="button" class="close-button" id="closeDetailsModalBtn" aria-label="Close">×</button>
                </div>
                <div class="modal-body" id="orderDetailsModalBody">
                    <!-- Details will be populated here by JS -->
                </div>
                <div class="modal-footer">
                    <button type="button" id="printOrderDetailBtn" class="info"><i class="fas fa-print"></i> Print Details</button>
                    <button type="button" id="closeDetailsModalFooterBtn" class="secondary"><i class="fas fa-times-circle"></i> Close</button>
                </div>
            </div>
        </div>
    </div>


    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // DOM Elements
        const ordersTableBody = document.getElementById('ordersTableBody');
        const noOrdersMessage = document.getElementById('noOrdersMessage');
        const ordersTable = document.getElementById('ordersTable');
        const printOrdersBtn = document.getElementById('printOrdersBtn');
        const clearOrdersBtn = document.getElementById('clearOrdersBtn');
        const searchInput = document.getElementById('searchInput');

        // Modal Elements (Add/Edit)
        const orderModal = document.getElementById('orderModal');
        const addOrderModalBtn = document.getElementById('addOrderModalBtn');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const cancelOrderBtn = document.getElementById('cancelOrderBtn');
        const orderForm = document.getElementById('orderForm');
        const modalTitle = document.getElementById('modalTitle');
        const saveOrderBtn = document.getElementById('saveOrderBtn');
        const editOrderOriginalIdInput = document.getElementById('editOrderOriginalId');

        // Form Fields
        const formFields = {
            orderId: document.getElementById('orderIdInput'),
            orderDate: document.getElementById('orderDate'),
            customerName: document.getElementById('customerName'),
            customerEmail: document.getElementById('customerEmail'),
            itemName: document.getElementById('itemName'),
            productSku: document.getElementById('productSku'),
            platform: document.getElementById('platformInput'), // New
            quantity: document.getElementById('quantity'),
            unitPrice: document.getElementById('unitPrice'),
            costPrice: document.getElementById('costPrice'),
            totalPrice: document.getElementById('totalPrice'),
            paymentMethod: document.getElementById('paymentMethod'),
            transactionId: document.getElementById('transactionId'),
            paymentDate: document.getElementById('paymentDate'),
            paymentStatus: document.getElementById('paymentStatus'),
            orderStatus: document.getElementById('orderStatus'),
            shippingAddress: document.getElementById('shippingAddress'),
            notes: document.getElementById('notes')
        };

        // Summary Dashboard Elements
        const summaryTotalOrders = document.getElementById('summaryTotalOrders');
        const summaryTotalRevenue = document.getElementById('summaryTotalRevenue');
        const summaryTotalCost = document.getElementById('summaryTotalCost');
        const summaryTotalProfit = document.getElementById('summaryTotalProfit');

        // Theme Toggle
        const themeCheckbox = document.getElementById('themeCheckbox');
        const themeLabel = document.getElementById('themeLabel');

        // Order Details Modal Elements
        const orderDetailsModal = document.getElementById('orderDetailsModal');
        const closeDetailsModalBtn = document.getElementById('closeDetailsModalBtn');
        const closeDetailsModalFooterBtn = document.getElementById('closeDetailsModalFooterBtn');
        const orderDetailsModalTitle = document.getElementById('orderDetailsModalTitle');
        const orderDetailsModalBody = document.getElementById('orderDetailsModalBody');
        const printOrderDetailBtn = document.getElementById('printOrderDetailBtn');

        // Local Storage Keys
        const LS_ORDERS_KEY = 'oms_orders_professional_v2'; // v2 for new fields/structure
        const LS_THEME_KEY = 'oms_theme_professional';

        let allOrders = [];
        let displayedOrders = [];
        let editingOrderOriginalId = null;

        // --- Utility Functions ---
        const formatCurrency = (amount) => `$${Number(amount).toFixed(2)}`;
        const formatDate = (dateString) => {
            if (!dateString) return '-';
            // Ensure dateString is treated as local, not UTC, to avoid off-by-one day issues.
            const [year, month, day] = dateString.split('-');
            return new Date(year, month - 1, day).toLocaleDateString();
        };

        // --- Theme Logic ---
        function setTheme(isDark) {
            document.body.classList.toggle('dark-theme', isDark);
            themeCheckbox.checked = isDark;
            themeLabel.textContent = isDark ? 'Light Mode' : 'Dark Mode';
            localStorage.setItem(LS_THEME_KEY, isDark ? 'dark' : 'light');
        }
        themeCheckbox.addEventListener('change', (e) => setTheme(e.target.checked));
        function loadTheme() {
            setTheme(localStorage.getItem(LS_THEME_KEY) === 'dark');
        }

        // --- Calculations ---
        function calculatePricesInForm() {
            const quantity = parseFloat(formFields.quantity.value) || 0;
            const unitPrice = parseFloat(formFields.unitPrice.value) || 0;
            const currentTotalPrice = quantity * unitPrice;
            formFields.totalPrice.value = currentTotalPrice.toFixed(2);
        }
        formFields.quantity.addEventListener('input', calculatePricesInForm);
        formFields.unitPrice.addEventListener('input', calculatePricesInForm);
        // Cost price input doesn't directly affect form display other than its own value

        // --- Order ID Generation ---
        function generateNewOrderId() {
            let maxIdNum = 99; // Start checking from 99 so that next is 100
            if (allOrders.length > 0) {
                allOrders.forEach(order => {
                    if (order.id && typeof order.id === 'string' && order.id.startsWith('ORD-')) {
                        const numPart = parseInt(order.id.substring(4), 10);
                        if (!isNaN(numPart) && numPart > maxIdNum) {
                            maxIdNum = numPart;
                        }
                    }
                });
            }
            return `ORD-${maxIdNum + 1}`;
        }

        // --- Add/Edit Modal Logic ---
        function openModal(mode = 'add', orderToEdit = null) {
            orderForm.reset();
            calculatePricesInForm();

            if (mode === 'add') {
                editingOrderOriginalId = null;
                editOrderOriginalIdInput.value = '';
                modalTitle.textContent = 'Add New Order';
                saveOrderBtn.innerHTML = '<i class="fas fa-save"></i> Save Order';
                formFields.orderId.value = generateNewOrderId();
                formFields.orderId.readOnly = true; // Auto-generated ID
                formFields.orderDate.valueAsDate = new Date();
            } else if (mode === 'edit' && orderToEdit) {
                editingOrderOriginalId = orderToEdit.id;
                editOrderOriginalIdInput.value = orderToEdit.id;
                modalTitle.textContent = `Edit Order: ${orderToEdit.id}`;
                saveOrderBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Update Order';
                
                formFields.orderId.value = orderToEdit.id;
                formFields.orderId.readOnly = true;
                formFields.orderDate.value = orderToEdit.orderDate;
                formFields.customerName.value = orderToEdit.customerName;
                formFields.customerEmail.value = orderToEdit.customerEmail || '';
                formFields.itemName.value = orderToEdit.itemName;
                formFields.productSku.value = orderToEdit.productSku || '';
                formFields.platform.value = orderToEdit.platform || ''; // New
                formFields.quantity.value = orderToEdit.quantity;
                formFields.unitPrice.value = orderToEdit.unitPrice;
                formFields.costPrice.value = orderToEdit.costPrice;
                formFields.paymentMethod.value = orderToEdit.paymentMethod || '';
                formFields.transactionId.value = orderToEdit.transactionId || '';
                formFields.paymentDate.value = orderToEdit.paymentDate || '';
                formFields.paymentStatus.value = orderToEdit.paymentStatus;
                formFields.orderStatus.value = orderToEdit.orderStatus;
                formFields.shippingAddress.value = orderToEdit.shippingAddress || '';
                formFields.notes.value = orderToEdit.notes || '';
                calculatePricesInForm();
            }
            orderModal.style.display = 'block';
            formFields.orderDate.focus(); // Focus first editable field
        }

        addOrderModalBtn.onclick = () => openModal('add');
        closeModalBtn.onclick = () => orderModal.style.display = 'none';
        cancelOrderBtn.onclick = () => orderModal.style.display = 'none';
        

        orderForm.addEventListener('submit', (event) => {
            event.preventDefault();
            const quantity = parseInt(formFields.quantity.value);
            const unitPrice = parseFloat(formFields.unitPrice.value);
            const costPrice = parseFloat(formFields.costPrice.value);

            const orderData = {
                id: formFields.orderId.value.trim(), // ID is readonly, but still get it
                orderDate: formFields.orderDate.value,
                customerName: formFields.customerName.value.trim(),
                customerEmail: formFields.customerEmail.value.trim(),
                itemName: formFields.itemName.value.trim(),
                productSku: formFields.productSku.value.trim(),
                platform: formFields.platform.value, // New
                quantity: quantity,
                unitPrice: unitPrice,
                costPrice: costPrice,
                totalPrice: quantity * unitPrice,
                totalCost: quantity * costPrice,
                profit: (quantity * unitPrice) - (quantity * costPrice),
                paymentMethod: formFields.paymentMethod.value,
                transactionId: formFields.transactionId.value.trim(),
                paymentDate: formFields.paymentDate.value,
                paymentStatus: formFields.paymentStatus.value,
                orderStatus: formFields.orderStatus.value,
                shippingAddress: formFields.shippingAddress.value.trim(),
                notes: formFields.notes.value.trim()
            };

            if (!orderData.id || !orderData.orderDate || !orderData.customerName || !orderData.itemName || isNaN(orderData.quantity) || isNaN(orderData.unitPrice) || isNaN(orderData.costPrice) ) {
                alert('Please fill in all required fields (Date, Customer, Item, Qty, Unit Price, Cost Price) correctly. Order ID is auto-generated.');
                return;
            }
            
            const originalIdBeingEdited = editOrderOriginalIdInput.value;
            if (originalIdBeingEdited) { // Editing
                const orderIndex = allOrders.findIndex(o => o.id === originalIdBeingEdited);
                if (orderIndex > -1) {
                    allOrders[orderIndex] = orderData;
                }
            } else { // Adding - ID collision check is less critical if always generated and readonly
                allOrders.push(orderData);
            }

            saveOrders();
            filterAndRenderOrders();
            orderModal.style.display = 'none';
        });

        // --- Order Details Modal Logic ---
        function openDetailsModal(order) {
            orderDetailsModalTitle.textContent = `Order Details: ${order.id}`;
            let detailsHtml = '<div class="details-grid">';

            function addDetailItem(label, value, iconClass = '') {
                const iconHtml = iconClass ? `<i class="${iconClass}"></i> ` : '';
                return `
                    <div class="detail-item">
                        <strong class="detail-label">${iconHtml}${label}:</strong>
                        <span class="detail-value">${value || '-'}</span>
                    </div>`;
            }

            detailsHtml += addDetailItem('Order ID', order.id, 'fas fa-hashtag');
            detailsHtml += addDetailItem('Order Date', formatDate(order.orderDate), 'fas fa-calendar-alt');
            detailsHtml += addDetailItem('Customer Name', order.customerName, 'fas fa-user');
            detailsHtml += addDetailItem('Customer Email', order.customerEmail, 'fas fa-envelope');
            detailsHtml += addDetailItem('Item Name(s)', order.itemName, 'fas fa-box-open');
            detailsHtml += addDetailItem('Product SKU', order.productSku, 'fas fa-barcode');
            detailsHtml += addDetailItem('Platform', order.platform, 'fas fa-store');
            detailsHtml += addDetailItem('Quantity', order.quantity, 'fas fa-sort-numeric-up');
            detailsHtml += addDetailItem('Unit Price', formatCurrency(order.unitPrice), 'fas fa-tag');
            detailsHtml += addDetailItem('Cost Price (Unit)', formatCurrency(order.costPrice), 'fas fa-money-bill-wave');
            detailsHtml += addDetailItem('Total Price', formatCurrency(order.totalPrice), 'fas fa-cash-register');
            detailsHtml += addDetailItem('Total Cost', formatCurrency(order.totalCost), 'fas fa-file-invoice-dollar');
            
            const profitText = formatCurrency(order.profit);
            const profitClass = order.profit >= 0 ? 'profit-positive' : 'profit-negative';
            detailsHtml += `
                <div class="detail-item">
                    <strong class="detail-label"><i class="fas fa-chart-pie"></i> Profit:</strong>
                    <span class="detail-value ${profitClass}">${profitText}</span>
                </div>`;

            detailsHtml += addDetailItem('Payment Method', order.paymentMethod, 'far fa-credit-card');
            detailsHtml += addDetailItem('Transaction ID', order.transactionId, 'fas fa-receipt');
            detailsHtml += addDetailItem('Payment Date', formatDate(order.paymentDate), 'fas fa-calendar-check');
            detailsHtml += addDetailItem('Payment Status', order.paymentStatus, 'fas fa-tasks'); // Changed icon
            detailsHtml += addDetailItem('Order Status', order.orderStatus, 'fas fa-truck-loading');
            detailsHtml += `</div>`; // Close details-grid

            detailsHtml += `<div class="detail-item-fullwidth">
                                <strong class="detail-label"><i class="fas fa-map-marker-alt"></i> Shipping Address:</strong>
                                <p class="detail-value-multiline">${order.shippingAddress ? order.shippingAddress.replace(/\n/g, '<br>') : '-'}</p>
                           </div>`;
            detailsHtml += `<div class="detail-item-fullwidth">
                                <strong class="detail-label"><i class="fas fa-sticky-note"></i> Notes/Comments:</strong>
                                <p class="detail-value-multiline">${order.notes ? order.notes.replace(/\n/g, '<br>') : '-'}</p>
                           </div>`;

            orderDetailsModalBody.innerHTML = detailsHtml;
            orderDetailsModal.dataset.currentOrderForPrint = JSON.stringify(order); // For print function
            orderDetailsModal.style.display = 'block';
        }

        closeDetailsModalBtn.onclick = () => orderDetailsModal.style.display = 'none';
        closeDetailsModalFooterBtn.onclick = () => orderDetailsModal.style.display = 'none';
        
        printOrderDetailBtn.addEventListener('click', () => {
            if (!orderDetailsModal.dataset.currentOrderForPrint) {
                alert("No order data to print."); return;
            }
            document.body.classList.add('print-details-modal-active');
            orderDetailsModal.classList.add('print-this-modal');
            window.print();
            // Use a timeout to allow print dialog to process before removing classes
            setTimeout(() => {
                document.body.classList.remove('print-details-modal-active');
                orderDetailsModal.classList.remove('print-this-modal');
            }, 500);
        });


        // Close modals on window click outside
        window.onclick = (event) => {
            if (event.target === orderModal) orderModal.style.display = 'none';
            if (event.target === orderDetailsModal) orderDetailsModal.style.display = 'none';
        };


        // --- Core Data Functions ---
        function loadOrders() {
            const storedOrders = localStorage.getItem(LS_ORDERS_KEY);
            allOrders = storedOrders ? JSON.parse(storedOrders) : [];
            // Ensure all orders have the new 'platform' field, default to empty if missing (for old data)
            allOrders.forEach(order => {
                if (order.platform === undefined) order.platform = '';
            });
            displayedOrders = [...allOrders];
        }

        function saveOrders() {
            localStorage.setItem(LS_ORDERS_KEY, JSON.stringify(allOrders));
        }

        function updateSummaryDashboard() {
            const totalOrders = displayedOrders.length;
            const totalRevenue = displayedOrders.reduce((sum, order) => sum + order.totalPrice, 0);
            const totalCost = displayedOrders.reduce((sum, order) => sum + order.totalCost, 0);
            const totalProfit = displayedOrders.reduce((sum, order) => sum + order.profit, 0);

            summaryTotalOrders.textContent = totalOrders;
            summaryTotalRevenue.textContent = formatCurrency(totalRevenue);
            summaryTotalCost.textContent = formatCurrency(totalCost);
            summaryTotalProfit.textContent = formatCurrency(totalProfit);

            // Apply class to the <p> tag itself for summary card
            const profitPElem = summaryTotalProfit; //document.getElementById('summaryTotalProfit');
            profitPElem.classList.remove('profit-positive', 'profit-negative'); // Clear previous classes
            if (totalProfit >= 0) {
                profitPElem.classList.add('profit-positive');
            } else {
                profitPElem.classList.add('profit-negative');
            }
        }

        function renderOrders(ordersToRender) {
            ordersTableBody.innerHTML = '';
            if (ordersToRender.length === 0) {
                noOrdersMessage.style.display = 'block';
                ordersTable.style.display = 'none';
            } else {
                noOrdersMessage.style.display = 'none';
                ordersTable.style.display = 'table';
                ordersToRender.forEach(order => {
                    const row = ordersTableBody.insertRow();
                    row.insertCell().textContent = order.id;
                    row.insertCell().textContent = formatDate(order.orderDate);
                    row.insertCell().textContent = order.customerName;
                    row.insertCell().textContent = order.itemName;
                    row.insertCell().textContent = order.platform || '-'; // New
                    row.insertCell().textContent = formatCurrency(order.unitPrice);
                    row.insertCell().textContent = formatCurrency(order.costPrice);
                    row.insertCell().textContent = formatCurrency(order.totalPrice);
                    
                    const profitCell = row.insertCell();
                    profitCell.textContent = formatCurrency(order.profit);
                    profitCell.className = order.profit >= 0 ? 'profit-positive' : 'profit-negative';

                    row.insertCell().textContent = order.paymentMethod || '-';
                    row.insertCell().textContent = order.paymentStatus;
                    row.insertCell().textContent = order.orderStatus;
                    
                    const actionsCell = row.insertCell();
                    actionsCell.classList.add('actions-cell');

                    const detailsButton = document.createElement('button');
                    detailsButton.innerHTML = '<i class="fas fa-eye"></i>';
                    detailsButton.title = "View Details";
                    detailsButton.classList.add('action-btn', 'info');
                    detailsButton.style.marginRight = '5px';
                    detailsButton.onclick = () => openDetailsModal(order);
                    actionsCell.appendChild(detailsButton);

                    const editButton = document.createElement('button');
                    editButton.innerHTML = '<i class="fas fa-edit"></i>';
                    editButton.title = "Edit Order";
                    editButton.classList.add('action-btn', 'secondary');
                    editButton.style.marginRight = '5px';
                    editButton.onclick = () => openModal('edit', order);
                    actionsCell.appendChild(editButton);

                    const deleteButton = document.createElement('button');
                    deleteButton.innerHTML = '<i class="fas fa-trash-alt"></i>';
                    deleteButton.title = "Delete Order";
                    deleteButton.classList.add('action-btn', 'danger');
                    deleteButton.onclick = () => deleteOrder(order.id);
                    actionsCell.appendChild(deleteButton);
                });
            }
        }

        function filterAndRenderOrders() {
            const searchTerm = searchInput.value.toLowerCase().trim();
            if (searchTerm === "") {
                displayedOrders = [...allOrders];
            } else {
                displayedOrders = allOrders.filter(order => {
                    return Object.values(order).some(value =>
                        String(value).toLowerCase().includes(searchTerm)
                    );
                });
            }
            // Sort orders by ID descending (newest first) based on numeric part of ID
            displayedOrders.sort((a, b) => {
                const numA = parseInt(String(a.id).substring(4), 10) || 0;
                const numB = parseInt(String(b.id).substring(4), 10) || 0;
                return numB - numA;
            });
            renderOrders(displayedOrders);
            updateSummaryDashboard();
        }

        searchInput.addEventListener('input', filterAndRenderOrders);

        function deleteOrder(orderIdToDelete) {
            const orderToDelete = allOrders.find(o => o.id === orderIdToDelete);
            if (confirm(`Are you sure you want to delete order "${orderToDelete.id} - ${orderToDelete.customerName}"? This will remove it permanently.`)) {
                allOrders = allOrders.filter(order => order.id !== orderIdToDelete);
                saveOrders();
                filterAndRenderOrders();
            }
        }

        // --- Button Event Listeners ---
        printOrdersBtn.addEventListener('click', () => {
            if (displayedOrders.length === 0) {
                alert("No orders to print in the current view.");
                return;
            }
            // Temporarily remove the details modal print active class if it's there
            const wasDetailsPrinting = document.body.classList.contains('print-details-modal-active');
            if(wasDetailsPrinting) {
                document.body.classList.remove('print-details-modal-active');
                orderDetailsModal.classList.remove('print-this-modal');
            }
            window.print();
            // Restore if it was there (though unlikely needed here)
            if(wasDetailsPrinting) {
                 setTimeout(() => { // Give print dialog a moment
                    document.body.classList.add('print-details-modal-active');
                    orderDetailsModal.classList.add('print-this-modal');
                }, 500);
            }
        });

        clearOrdersBtn.addEventListener('click', () => {
            if (allOrders.length === 0) {
                alert("No orders to clear."); return;
            }
            if (confirm('WARNING: This will delete ALL orders permanently. Are you absolutely sure?')) {
                allOrders = [];
                displayedOrders = [];
                saveOrders();
                renderOrders(displayedOrders);
                updateSummaryDashboard();
            }
        });

        // --- Initial Load ---
        loadTheme();
        loadOrders();
        filterAndRenderOrders(); // Initial render, sort, and summary calculation
    });
    </script>
</body>
</html>
